<!DOCTYPE html><html lang="en-en"><head><title>Residency Update</title><meta charset="utf-8" /><meta content="samuel giddins" name="keywords" /><meta content="IE=edge" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="" name="description" /><meta content="" name="author" /><meta content="True" name="HandheldFriendly" /><meta content="320" name="MobileOptimized" /><link href="/stylesheets/app.css" rel="stylesheet" type="text/css" /><script src="/scripts/app.js" type="text/javascript"></script></head><body class="home blog"><div id="container"><header class="header"><div class="wrap clearfix" id="inner-header"><div class="h1" id="site-title"><a href="//segiddins.me" rel="nofollow">Samuel Giddins</a></div><div id="site-description"><h2>Staff Software Engineer</h2></div><section class="social wrap"><div><a class="symbol" href="https://github.com/segiddins" rel="me" title="&#xe237;"></a><a class="symbol" href="mailto:segiddins@segiddins.me" rel="me" title="&#xe024;"></a><a class="symbol" href="tel:9178873993" rel="me" title="&#xe049;"></a><a href='https://www.linkedin.com/in/segiddins' rel="me" class='symbol' title='&#xe052;'></a></div></section><nav id="site-navigation"><ul><li><a href="//segiddins.me">About Me</a></li><li><a href="//blog.segiddins.me">Blog</a></li><li><a href="//blog.segiddins.me/rss">RSS</a></li></ul></nav></div></header><article class="wrap hentry clearfix"><header class="article-header"><h1 class="h2"><h2 class="h2"><a href="/2024/03/15/residency-update/" title="Residency Update">Residency Update</a></h2></h1><p class="byline vcard"><span>By </span><span class="author"><a href="https://twitter.com/segiddins">Samuel Giddins</a></span><span> on </span><time class="updated">Friday, March 15th, 2024</time></p></header><section class="entry-content clearfix"><p>Welcome to my sixth update as <a href="https://rubycentral.org/news/ruby-central-welcomes-new-software-engineer-in-residence-sponsored-by-aws/">Ruby Central&rsquo;s security engineer in residence, sponsored by AWS</a>.</p>

<p>My goal is to write a short update every week, chronicling what I&rsquo;ve been working on, and reminding myself that I was, in fact, productive.</p>



<h2 id="fixing-a-common-source-of-oncall-pages">Fixing a common source of ONCALL pages</h2>

<p>As I mentioned <a href="https://blog.segiddins.me/2024/03/08/residency-update/#fixing-a-common-source-of-oncall-pages">last week</a>, I had found that by far our most expensive query was for reverse dependencies of a gem.
I shipped my fix last weekend, and it sure made a difference.</p>

<p><img alt="alt text" width="1560" height="546" src="/images/2024-03-15-residency-update/reverse_dependencies_p75.png" /></p>

<h2 id="fixing-n-1-queries">Fixing N+1 Queries</h2>

<p>Unfortunately, most of my week was spent on RubyGems.org operational issues.
I had noticed that many of our slowest endpoints had a very large number of queries being executed,
and I spent a bunch of time digging into root causes in DataDog to figure out why.
It turned out we had a spate of N+1 queries, and heavy automated usage of the site&rsquo;s API
(along with scraping of the HTML pages) caused heavy load on those endpoints.</p>

<p>As a result, our postgres database got overloaded several times during the week, leading to multiple
members of the oncall rotation (including yours truly) to be paged over and over.
It wasn&rsquo;t fun.</p>

<p>Fortunately, the Rails ecosystem has several tools to help narrow in on N+1 queries!
After slapping <code>strict_loading</code> on several queries and adding in <code>includes</code> and <code>preload</code>
calls, I brought out the big guns to find the remaining offenders.</p>

<p>Setting up the wonderful <a href="https://rubygems.org/gems/prosopite">prosopite</a> gem led to <a href="https://github.com/rubygems/rubygems.org/pull/4525">several more fixes</a>.
After a hurried emergency deploy on Thursday afternoon, we saw an immediate improvement
across the board and the site once again appears to be stable!</p>

<p><img alt="alt text" width="1550" height="524" src="/images/2024-03-15-residency-update/image.png" /></p>

<p><img alt="alt text" width="1528" height="552" src="/images/2024-03-15-residency-update/image-1.png" /></p>

<p>Top requests over the past 24 hours</p>

<p><img alt="alt text" width="3172" height="754" src="/images/2024-03-15-residency-update/image-2.png" /></p>

<p>Average time spent per request on Api::V1::VersionsController#show</p>

<p><img alt="alt text" width="1550" height="526" src="/images/2024-03-15-residency-update/image-3.png" /></p>

<p>Problematic N+1 query (getting gem version download count)</p>

<p><img alt="alt text" width="2140" height="598" src="/images/2024-03-15-residency-update/image-4.png" /></p>

<p>Finally, it appears that there are some users who are scraping every gem &amp; version page/endpoint.
We would strongly reccomend that researchers &amp; other automated platforms use the data dumps we provide if possible,
and make decisions on what endpoints to call to refresh data based upon changes in the <code>/versions</code> file, which is statically generated
and thus causes no load on the rails app or database.</p>

<h2 id="sigstore">Sigstore</h2>

<p>Few updates this week, due to the aformentioned operational work.
I did make progress on protobuf compliance, though!</p>
</section><footer class="article-footer"></footer></article><footer class="container footer"><div class="clearfix" id="inner-footer"><section class="recent wrap sevencol first clearfix"><nav class="pagination"><a class="newer-posts" href="/2024/03/08/residency-update/">&larr; Previous</a><span class="page-number">Page 59 of 59</span><p><a href="//blog.segiddins.me/archive">Archive</a></p></nav></section><section class="sidebar fivecol clearfix"><header class="sidebar-header"><h3>Samuel Giddins</h3><h4>Staff Software Engineer</h4></header><nav class="sidebar-menu vertical"><ul><li><a href="//segiddins.me">About Me</a><span> | </span></li><li><a href="//blog.segiddins.me">Blog</a><span> | </span></li><li><a href="//blog.segiddins.me/rss">RSS</a></li></ul></nav><section class="social wrap"><div><a class="symbol" href="https://github.com/segiddins" rel="me" title="&#xe237;"></a><a class="symbol" href="mailto:segiddins@segiddins.me" rel="me" title="&#xe024;"></a><a class="symbol" href="tel:9178873993" rel="me" title="&#xe049;"></a><a href='https://www.linkedin.com/in/segiddins' rel="me" class='symbol' title='&#xe052;'></a></div></section></section></div><div class="source-og copyright"><span>Â© 2012-2024 </span><a href="//segiddins.me">Samuel Giddins</a></div></footer></div></body></html>